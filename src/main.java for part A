import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.io.FileNotFoundException;
import java.io.IOException;
import java.sql.*;
import java.util.ArrayList;
import java.util.Collections;
import java.util.Scanner;

public class Midterm {

    static Connection conn;
    static Statement stmt;
    static ResultSet resultSet;

    public static void main(String[] args) throws SQLException, FileNotFoundException {
        String website = "https://aps2.missouriwestern.edu/schedule/Default.asp?tck=201910";
        String connectStmt = "jdbc:sqlite:Schedule.db";

        menu(website, connectStmt);
    }

    public static void menu(String website, String connectStmt){
        char ch;
        do{
            System.out.println("\nMENU");
            System.out.print("A = Erase and build subject table.\n" +
                    "B = Erase and build department table.\n" +
                    "C = Print subject table.\n" +
                    "D = Print department table.\n" +
                    "E = Print report of discipline by department\n" +
                    "Q = Quit.\n");
            System.out.println("Please type in your choice:");
            Scanner input = new Scanner(System.in);
            String choice = input.next().toUpperCase().trim();
            ch = (choice.length() > 0)? choice.charAt(0): 'x';
            switch(ch){
                case 'A':
                    eraseAndBuilddisciplines(website, connectStmt);
                    break;
                case 'B':
                    eraseAndBuildDepartments(website, connectStmt);
                    break;
                case 'C':
                    printDisciplineTable(connectStmt);
                    break;
                case 'D':
                    printDepartmentTable(connectStmt);
                    break;
                case 'E':
                    String topic;
                    do{
                        System.out.println("Please enter in the abbreviation of the department you want to search.");
                        System.out.println("Enter R if ou want to stop searching");
                        Scanner dep_abbrev = new Scanner(System.in);
                        topic = dep_abbrev.next().toUpperCase().trim();
                        switch(topic){
                            case "R":
                                break;
                            default:
                                printDisciplinesByDepartment(topic, connectStmt);
                        }
                    }while(!topic.equals("R"));
                    break;
                case 'Q':
                    break;
                default:
                    System.out.println("You still have to type a letter from the menu!!");
            }
        }while(ch != 'Q');
    }

    public static void eraseAndBuilddisciplines(String website, String connectStmt){
        try {
            conn = DriverManager.getConnection(connectStmt);
            stmt = conn.createStatement();
            stmt.execute("delete from disciplines");

            Document doc = Jsoup.connect(website).get();
            Elements subject = doc.select("select#subject > option");

            for(Element option: subject){
                String dis_abbrev = option.attr("value");
                String dis_name = option.select("[value]").text();
                String dep_name = matchDepartment(website, dis_abbrev);
                stmt.executeUpdate("insert into disciplines(dis_abbrev, dis_name, dep_abbrev) values('" + dis_abbrev + "', '"  + dis_name + "', '" + dep_name + "')");
            }

            stmt.execute("delete from disciplines where dis_abbrev like 'ALL'");
            stmt.execute("delete from disciplines where dis_name like 'ALL disciplines'");
            conn.close();
        } catch (SQLException | IOException e) {
            e.printStackTrace();
        }

        System.out.println("Erasing and building disciplines table successful.");
    }

    public static void eraseAndBuildDepartments(String website, String connectStmt){
        try {
            conn = DriverManager.getConnection(connectStmt);
            stmt = conn.createStatement();
            stmt.execute("delete from departments");

            Document doc = Jsoup.connect(website).get();
            Elements department = doc.select("select#department > option");

            for(Element option: department){
                String dep_abbrev = option.attr("value");
                String dep_name = option.select("[value]").text();
                stmt.executeUpdate("insert into departments(dep_abbrev, dep_name) values('" + dep_abbrev + "', '"  + dep_name +"')");
            }

            stmt.execute("delete from departments where dep_abbrev like 'ALL'");
            stmt.execute("delete from departments where dep_name like 'ALL Departments'");
            conn.close();
        } catch (SQLException | IOException e) {
            e.printStackTrace();
        }

        System.out.println("Erasing and building departments table successful.");
    }

    public static void printDisciplineTable(String connectStmt){
        try {
            conn = DriverManager.getConnection(connectStmt);
            stmt = conn.createStatement();
            stmt.execute("select * from disciplines");
            resultSet = stmt.getResultSet();

            System.out.println("\nSUBJECT TABLE");
            System.out.println("dis_abbrev      dis_name");

            while(resultSet.next()) {
                String abbrev = resultSet.getString("dis_abbrev");
                String name = resultSet.getString("dis_name");
                System.out.printf("%-15s %s\n", abbrev, name);
            }
            conn.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }

        System.out.println("Printing disciplines table complete.");
    }

    public static void printDepartmentTable(String connectStmt){
        try {
            conn = DriverManager.getConnection(connectStmt);
            stmt = conn.createStatement();
            stmt.execute("select * from departments");
            resultSet = stmt.getResultSet();

            System.out.println("\nDEPARTMENT TABLE");
            System.out.println("DEP_ABBREV      DEP_NAME");

            while(resultSet.next()) {
                String abbrev = resultSet.getString("dep_abbrev");
                String name = resultSet.getString("dep_name");
                System.out.printf("%-15s %s\n", abbrev, name);
            }
            conn.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }

        System.out.println("Printing departments table complete.");
    }

    public static void printDisciplinesByDepartment(String dep_abbrev, String connectStmt){
        try {
            conn = DriverManager.getConnection(connectStmt);
            stmt = conn.createStatement();
            stmt.execute("select dep_name from departments where dep_abbrev like '" + dep_abbrev + "')");
            resultSet = stmt.getResultSet();
            while(resultSet.next()){
                String dep_name = resultSet.getString("dep_name");
                System.out.println(dep_abbrev + " - " + dep_name);
            }
            stmt.execute("select dis_abbrev, dis_name, dep_abbrev from disciplines where dep_abbrev like '" + dep_abbrev + "')");
            resultSet = stmt.getResultSet();
            while(resultSet.next()){
                String dis_abbrev = resultSet.getString("dis_abbrev");
                String dis_name = resultSet.getString("dis_name");
                System.out.printf("\t%s - %s\n", dis_abbrev, dis_name);
            }
            conn.close();
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    public static ArrayList departmentSearch(String website, String dep_name){
        String search = dep_name.toUpperCase().trim();
        ArrayList<String> myDis = new ArrayList<>();
        Document doc = null;
        org.jsoup.Connection.Response response = null;
        try {
            response = Jsoup.connect(website)
                    .timeout(60 * 1000)
                    .method(org.jsoup.Connection.Method.POST)
                    .data("course_number", "")
                    .data("subject", "ALL")
                    .data("department", search)
                    .data("display_closed", "yes")
                    .data("course_type", "ALL")
                    .followRedirects(true)
                    .execute();
            doc = response.parse();
            Elements course = doc.select("a");
            for(int i=0; i<course.size(); i++){
                String dis_abbrev = course.get(i).select("[href]").text().trim();
                if(dis_abbrev.length() == 6) {
                    if(isInDisciplineList(dis_abbrev, myDis)) myDis.add(dis_abbrev.substring(0,3));
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return myDis;
    }

    public static boolean isInDisciplineList(String dis_abbrev, ArrayList myDis){
        boolean result = false;
        for(int i=0; i<myDis.size(); i++){
            if(!dis_abbrev.equals(myDis.get(i))) result = true;
        }
        return result;
    }

    public static ArrayList departmentToArrayList(String website) {
        ArrayList<String> myDepartment = new ArrayList<>();
        Document doc = null;
        try {
            doc = Jsoup.connect(website).get();
            Elements department = doc.select("select#department > option");

            for (Element option : department) {
                String dep_name = option.select("[value]").text();
                myDepartment.add(dep_name);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return myDepartment;
    }

    public static String matchDepartment(String website, String dis_abbrev){
        String dep_abbrev = null;
        ArrayList<Object> myDep = new ArrayList<>();
        Collections.addAll(myDep, departmentToArrayList(website));
        ArrayList<Object> myDis = new ArrayList<>();
        for(int i=0; i<myDep.size(); i++){
            myDis.clear();
            Collections.addAll(myDis, departmentSearch(website, (String)myDep.get(i)));
            for(int j=0; j<myDis.size(); j++){
                if(dis_abbrev.equals(myDis.get(j))){
                    dep_abbrev = (String)myDep.get(i);
                }
            }
        }
        return dep_abbrev;
    }
}
